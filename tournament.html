<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ† HORST í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(120deg, #000010, #080031, #000010);
      color: #e3e3e3;
      text-align: center;
      padding: 20px;
    }

    h2 {
      color: #00f2ff;
      text-shadow: 0 0 5px #00f2ff;
      margin-bottom: 10px;
    }

    .match {
      background: #1a1a1a;
      border: 2px solid #7b2ff7;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 0 20px rgba(123, 47, 247, 0.3);
    }

    .match p {
      margin: 10px 0;
    }

    .winner-button {
      padding: 12px 20px;
      margin: 5px;
      background: linear-gradient(90deg, #00f2ff, #7b2ff7);
      color: black;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.2s;
    }

    .winner-button:hover {
      transform: scale(1.05);
      opacity: 0.9;
    }

    .disabled {
      background: gray !important;
      cursor: not-allowed;
    }

    .map-info {
      font-size: 16px;
      margin-top: 10px;
      color: #ffaa00;
    }

    .register-btn {
      margin-top: 20px;
      background: linear-gradient(90deg, #00f2ff, #7b2ff7);
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1.2rem;
      cursor: pointer;
      transition: 0.2s;
    }

    .register-btn:hover {
      transform: scale(1.05);
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <h2>ğŸ† 4ê°• í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ</h2>
  <div id="tournamentInfo">í† ë„ˆë¨¼íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <div id="bracket">ë¡œë”© ì¤‘...</div>

  <!-- í† ë„ˆë¨¼íŠ¸ ì°¸ê°€ ë²„íŠ¼ -->
  <button id="registerBtn" class="register-btn">í† ë„ˆë¨¼íŠ¸ ì°¸ê°€</button>

  <script type="module">
    import { db } from './firebase.js';
    import { ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const bracket = document.getElementById("bracket");
    const tournamentInfo = document.getElementById("tournamentInfo");
    const currentUser = localStorage.getItem("currentUser");

    let tournamentData = {};

    // í† ë„ˆë¨¼íŠ¸ ì •ë³´ ì´ˆê¸°í™”
    async function initializeTournament() {
      const now = new Date();
      const snap = await get(ref(db, "tournament"));
      const data = snap.val();

      if (!data || new Date(data.startTime) <= now || data.status === "ended") {
        // ìƒˆë¡œìš´ í† ë„ˆë¨¼íŠ¸ ì‹œì‘ (ë§¤ì£¼ ê¸ˆìš”ì¼ ì˜¤í›„ 7ì‹œ)
        const nextFriday = new Date();
        nextFriday.setDate(now.getDate() + ((12 - now.getDay()) % 7)); // ë‹¤ìŒ ê¸ˆìš”ì¼ë¡œ ì„¤ì •
        nextFriday.setHours(19, 0, 0, 0);

        const mapList = [
          "ì˜ì›ì˜ ì „ìŸí„°", "ìš©ì˜ ë‘¥ì§€", "í•˜ëŠ˜ ì‚¬ì›",
          "ë¸Œë½ì‹œìŠ¤ í•­ì „", "íŒŒë©¸ì˜ íƒ‘", "ë³¼ìŠ¤ì¹´ì•¼ ê³µì¥",
          "ì €ì£¼ì˜ ê³¨ì§œê¸°", "ê±°ë¯¸ ì—¬ì™•ì˜ ë¬´ë¤"
        ];
        const newMap = mapList[Math.floor(Math.random() * mapList.length)];

        tournamentData = {
          startTime: nextFriday.toISOString(),
          status: "open",
          participants: [], // ì°¸ê°€ì ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
          map: newMap,
          teams: null, // íŒ€ ì •ë³´ ì´ˆê¸°í™”
          matches: null // ë§¤ì¹­ ì •ë³´ ì´ˆê¸°í™”
        };

        await set(ref(db, "tournament"), tournamentData);
      } else {
        tournamentData = data;  // ê¸°ì¡´ í† ë„ˆë¨¼íŠ¸ ë°ì´í„° ë¡œë“œ
      }
    }

    // í† ë„ˆë¨¼íŠ¸ ì •ë³´ í‘œì‹œ
    function displayTournamentInfo() {
      const startTime = new Date(tournamentData.startTime);
      const now = new Date();
      const diffMs = startTime - now;
      const remaining = `${Math.floor(diffMs / (1000 * 60 * 60 * 24))}ì¼ ${Math.floor(diffMs / (1000 * 60 * 60)) % 24}ì‹œê°„ ${(Math.floor(diffMs / (1000 * 60)) % 60)}ë¶„ ${(Math.floor(diffMs / 1000) % 60)}ì´ˆ`;

      tournamentInfo.innerHTML = `
        <p>ğŸ“ í† ë„ˆë¨¼íŠ¸ ë§µ: <strong>${tournamentData.map}</strong></p>
        <p>â° ì‹œì‘ê¹Œì§€ ë‚¨ì€ ì‹œê°„: <strong>${remaining}</strong></p>
        <p>ğŸ‘¥ í˜„ì¬ ì°¸ê°€ì ìˆ˜: <strong>${tournamentData.participants.length}</strong>/20</p>
      `;
    }

    // ì°¸ê°€ ì‹ ì²­
    async function registerForTournament() {
      if (tournamentData.status !== "open") {
        alert("í˜„ì¬ í† ë„ˆë¨¼íŠ¸ëŠ” ì§„í–‰ ì¤‘ì´ê±°ë‚˜ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        return;
      }

      if (tournamentData.participants.includes(currentUser)) {
        alert("ì´ë¯¸ ì°¸ê°€í•œ í† ë„ˆë¨¼íŠ¸ì…ë‹ˆë‹¤.");
        return;
      }

      tournamentData.participants.push(currentUser);
      await update(ref(db, "tournament"), { participants: tournamentData.participants });
      alert("í† ë„ˆë¨¼íŠ¸ì— ì°¸ê°€ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!");
      displayTournamentInfo();
    }

    // í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ ì¶œë ¥
    function renderBracket() {
      if (!tournamentData.teams) return;

      const teams = tournamentData.teams;
      const matches = tournamentData.matches;

      bracket.innerHTML = `
        <h3>ğŸ® í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ</h3>
        <p>ğŸŒ ë§µ: ${tournamentData.map}</p>
      `;

      Object.keys(matches).forEach(matchKey => {
        const match = matches[matchKey];
        const teamA = teams[match.team1];
        const teamB = teams[match.team2];
        const winner = match.winner ? `âœ… ìŠ¹ë¦¬íŒ€: ${match.winner}` : "â“ ìŠ¹ë¦¬íŒ€ ë¯¸ì„ íƒ";

        const matchHTML = `
          <div class="match">
            <p><strong>${teamA.join(", ")}</strong> vs <strong>${teamB.join(", ")}</strong></p>
            <p>${winner}</p>
            <button class="winner-button" onclick="reportWinner('${matchKey}', '${match.team1}')">ìŠ¹ë¦¬: ${teamA.join(", ")}</button>
            <button class="winner-button" onclick="reportWinner('${matchKey}', '${match.team2}')">ìŠ¹ë¦¬: ${teamB.join(", ")}</button>
          </div>
        `;

        bracket.innerHTML += matchHTML;
      });
    }

    // ìŠ¹ë¦¬ íŒ€ ë³´ê³ 
    async function reportWinner(matchKey, winningTeam) {
      if (!confirm(`${winningTeam} íŒ€ì´ ìŠ¹ë¦¬ íŒ€ìœ¼ë¡œ í™•ì •ë˜ë©´ í† ë„ˆë¨¼íŠ¸ê°€ ì¢…ë£Œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      await update(ref(db, `tournament/matches/${matchKey}`), { winner: winningTeam });
      alert(`${winningTeam} íŒ€ ìŠ¹ë¦¬ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      renderBracket();
    }

    // í† ë„ˆë¨¼íŠ¸ ì°¸ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ
    document.getElementById("registerBtn").addEventListener("click", async () => {
      await registerForTournament();
    });

    // í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œì™€ ì •ë³´ë¥¼ ë¡œë“œ
    initializeTournament().then(() => {
      displayTournamentInfo();
      renderBracket();
    });
  </script>
</body>
</html>
