<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>🏆 HORST 토너먼트 대진표</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(120deg, #000010, #080031, #000010);
      color: #e3e3e3;
      text-align: center;
      padding: 20px;
    }

    h2 {
      color: #00f2ff;
      text-shadow: 0 0 5px #00f2ff;
      margin-bottom: 10px;
    }

    .match {
      background: #1a1a1a;
      border: 2px solid #7b2ff7;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 0 20px rgba(123, 47, 247, 0.3);
    }

    .match p {
      margin: 10px 0;
    }

    .winner-button {
      padding: 12px 20px;
      margin: 5px;
      background: linear-gradient(90deg, #00f2ff, #7b2ff7);
      color: black;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.2s;
    }

    .winner-button:hover {
      transform: scale(1.05);
      opacity: 0.9;
    }

    .disabled {
      background: gray !important;
      cursor: not-allowed;
    }

    .map-info {
      font-size: 16px;
      margin-top: 10px;
      color: #ffaa00;
    }
  </style>
</head>
<body>
  <h2>🏆 4강 토너먼트 대진표</h2>
  <div id="bracket">로딩 중...</div>

  <script type="module">
    import { db } from './firebase.js';
    import { ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const bracket = document.getElementById("bracket");
    const currentUser = localStorage.getItem("currentUser");

    // 자동 다음 토너먼트 초기화
    async function ensureUpcomingTournament() {
      const now = new Date();
      const snap = await get(ref(db, "tournament"));
      const data = snap.val();
      const currentStart = new Date(data?.startTime || 0);

      if (!data || now > currentStart) {
        const nextFriday = new Date();
        nextFriday.setDate(now.getDate() + ((12 - now.getDay()) % 7));
        nextFriday.setHours(19, 0, 0, 0);
        const mapList = [
          "영원의 전쟁터", "용의 둥지", "하늘 사원",
          "브락시스 항전", "파멸의 탑", "볼스카야 공장",
          "저주의 골짜기", "거미 여왕의 무덤"
        ];
        const newMap = mapList[Math.floor(Math.random() * mapList.length)];

        await set(ref(db, "tournament"), {
          startTime: nextFriday.toISOString(),
          status: "open",
          participants: [],
          map: newMap,
          teams: null,
          matches: null
        });
        return {
          startTime: nextFriday,
          map: newMap,
          teams: null,
          matches: null,
          participants: [],
          status: "open"
        };
      }
      return data;
    }

    const tournament = await ensureUpcomingTournament();
    const startTime = new Date(tournament.startTime);
    const now = new Date();
    const diffHours = Math.floor((startTime - now) / (1000 * 60 * 60));
    const diffMinutes = Math.floor((startTime - now) % (1000 * 60 * 60) / (1000 * 60));

    if (!tournament.teams) {
      bracket.innerHTML = `
        <p class="map-info">⏰ 다음 토너먼트: <strong style="color:#7bffb4;">${startTime.toLocaleString()}</strong></p>
        <p class="map-info">📍 맵: <strong style="color:skyblue;">"${tournament.map}"</strong></p>
        <p class="map-info">👥 현재 신청 인원: ${tournament.participants?.length || 0}/20</p>
        <p><button onclick="window.location.href='index.html'">🔙 메인으로 돌아가기</button></p>
      `;
    } else {
      const teams = tournament.teams;
      const matches = tournament.matches || {};
      const usersSnap = await get(ref(db, "users"));
      const users = usersSnap.val() || {};

      const teamLeaders = {};
      for (const teamKey of Object.keys(teams)) {
        const teamMembers = teams[teamKey];
        let topUser = teamMembers[0];
        let topScore = users[topUser]?.points || 0;
        for (const user of teamMembers) {
          const score = users[user]?.points || 0;
          if (score > topScore) {
            topUser = user;
            topScore = score;
          }
        }
        teamLeaders[teamKey] = topUser;
      }

      const renderMatch = (matchKey, team1, team2) => {
        const winner = matches[matchKey]?.winner || "";
        const leader1 = teamLeaders[team1];
        const leader2 = teamLeaders[team2];

        return `
          <div class="match">
            <p><strong>${team1}팀</strong>: ${teams[team1].join(", ")}</p>
            <p><strong>${team2}팀</strong>: ${teams[team2].join(", ")}</p>
            <p>${winner ? `✅ <strong>${winner}팀 승리</strong>` : "❓ 승리팀 선택 대기 중"}</p>
            <button class="winner-button" onclick="reportResult('${matchKey}', '${team1}')" 
              ${currentUser !== leader1 || winner ? "disabled class='disabled'" : ""}>
              ${team1}팀 승리
            </button>
            <button class="winner-button" onclick="reportResult('${matchKey}', '${team2}')" 
              ${currentUser !== leader2 || winner ? "disabled class='disabled'" : ""}>
              ${team2}팀 승리
            </button>
          </div>
        `;
      };

      bracket.innerHTML = `
        <p class="map-info">📍 이번 토너먼트는 <strong style="color:skyblue;">"${tournament.map}"</strong> 맵으로 진행됩니다.</p>
        ${renderMatch("semiFinal1", "A", "B")}
        ${renderMatch("semiFinal2", "C", "D")}
      `;
    }

    // 결과 보고
    window.reportResult = async (matchKey, winnerTeam) => {
      if (!confirm(`${winnerTeam}팀의 승리를 입력하시겠습니까?`)) return;
      await update(ref(db, `tournament/matches/${matchKey}`), { winner: winnerTeam });
      alert(`${winnerTeam}팀 승리가 기록되었습니다.`);
      location.reload();
    };
  </script>
</body>
</html>
